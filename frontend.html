<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a7cff">
    <title>Recomendador de Ofertas Laborales</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg: linear-gradient(180deg, #0a0f23, #0b122a 40%, #0b122a 60%, #091129);
        --panel: #0f172a;
        --panel-2: #0c1428;
        --card: #0f1b36;
        --text: #e6eefc;
        --muted: #9fb2d3;
        --brand: #2aa0ff;
        --brand-2: #7cc5ff;
        --accent: #15c97d;
        --warn: #ffd569;
        --error: #ff7a7a;
        --shadow: 0 10px 30px rgba(0,0,0,0.35);
        --radius: 14px;
        --advice-bg: rgba(255,213,105,0.08);
        --advice-text: #ffeab3;
      }
      :root[data-theme="light"] {
        --bg: linear-gradient(180deg, #f5f7fb, #edf2ff 50%, #edf2ff 100%);
        --panel: #ffffff;
        --panel-2: #f4f7ff;
        --card: #ffffff;
        --text: #0f1b36;
        --muted: #51627f;
        --brand: #0a7cff;
        --brand-2: #0a7cff;
        --accent: #15c97d;
        --warn: #e3a600;
        --error: #c0392b;
        --shadow: 0 8px 24px rgba(0,0,0,0.12);
        --radius: 14px;
        --advice-bg: #fff7d6;
        --advice-text: #6b5200;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; background: var(--bg);
        color: var(--text); font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      }
      .wrapper { max-width: 1200px; margin: 0 auto; padding: 24px; }
      header.nav {
        display: flex; align-items: center; justify-content: space-between; gap: 16px;
        padding: 14px 18px; border-radius: 16px; background: linear-gradient(180deg, #0e1936, #0a1330);
        box-shadow: var(--shadow); position: sticky; top: 12px; z-index: 20;
      }
      :root[data-theme="light"] header.nav { background: #ffffff; border: 1px solid rgba(10,124,255,0.15); }
      .brand { display: flex; gap: 12px; align-items: center; }
      .logo {
        width: 36px; height: 36px; border-radius: 10px;
        background: linear-gradient(145deg, var(--brand), var(--accent));
        box-shadow: 0 6px 16px rgba(42,160,255,.35), inset 0 1px 0 rgba(255,255,255,.15);
      }
      .brand h1 { font-size: 18px; margin: 0; letter-spacing: .3px; }
      .beta { color: var(--muted); font-size: 12px; letter-spacing: .6px; text-transform: uppercase; }

      .layout { display: grid; grid-template-columns: 1fr 1.4fr; gap: 20px; margin-top: 20px; }
      @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }

      .panel { background: linear-gradient(180deg, #0b1836, #0a1530); border: 1px solid rgba(124,197,255,0.12); border-radius: var(--radius); box-shadow: var(--shadow); }
      :root[data-theme="light"] .panel { background: #ffffff; border: 1px solid rgba(10,124,255,0.12); }
      .panel .head { padding: 18px 20px; border-bottom: 1px solid rgba(124,197,255,0.12); display: flex; align-items: center; justify-content: space-between; }
      .panel .head h2 { margin: 0; font-size: 16px; font-weight: 600; color: var(--brand-2); letter-spacing: .4px; }
      .panel .body { padding: 18px 20px; }

      label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
      input[type="text"], select {
        width: 100%; background: #0b1938; color: var(--text); border: 1px solid rgba(124,197,255,0.18);
        border-radius: 10px; padding: 12px 12px; font-size: 14px; outline: none;
        transition: border-color .2s ease, box-shadow .2s ease;
      }
      :root[data-theme="light"] input[type="text"], :root[data-theme="light"] select { background: #f7faff; border-color: rgba(10,124,255,0.18); }
      input[type="text"]:focus, select:focus { border-color: var(--brand-2); box-shadow: 0 0 0 3px rgba(42,160,255,0.15); }

      .soft-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
      .soft-item { background: #0b1936; border: 1px solid rgba(124,197,255,0.12); border-radius: 12px; padding: 10px 12px; }
      :root[data-theme="light"] .soft-item { background: #f7faff; border-color: rgba(10,124,255,0.12); }
      .soft-row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
      .soft-row .value { font-size: 12px; color: var(--brand-2); min-width: 34px; text-align: right; }
      .soft-label { font-size: 13px; color: #e3edff; }
      :root[data-theme="light"] .soft-label { color: #0f1b36; }
      .slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: linear-gradient(90deg, var(--brand) 0%, #1f3e7d 100%); border-radius: 999px; outline: none; }
      .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: #fff; border-radius: 50%; border: 3px solid var(--brand); box-shadow: 0 3px 10px rgba(42,160,255,.4); cursor: pointer; }
      .slider::-moz-range-thumb { width: 22px; height: 22px; background: #fff; border-radius: 50%; border: 3px solid var(--brand); box-shadow: 0 3px 10px rgba(42,160,255,.4); cursor: pointer; }

      .actions { margin-top: 14px; display: flex; gap: 10px; }
      .btn {
        background: linear-gradient(135deg, var(--brand), #0ea5ff); border: 0; color: white; padding: 12px 16px; border-radius: 12px; font-weight: 600;
        letter-spacing: .2px; cursor: pointer; flex: 1; box-shadow: 0 8px 20px rgba(42,160,255,.35); transition: transform .05s ease;
      }
      .btn:active { transform: translateY(1px); }
      .btn:disabled { opacity: .65; cursor: not-allowed; }
      .error { color: var(--error); margin-top: 8px; font-size: 13px; }

      .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(42,160,255,.15); color: var(--brand-2); font-size: 12px; letter-spacing: .3px; }
      .result-section h3 { margin: 0 0 10px; font-size: 18px; color: var(--brand-2); }
      .cards { display: grid; grid-template-columns: 1fr; gap: 12px; }
      .card { background: linear-gradient(180deg, #0e1e3f, #0a1530); border: 1px solid rgba(124,197,255,0.12); border-radius: 14px; padding: 14px; box-shadow: var(--shadow); }
      :root[data-theme="light"] .card { background: #ffffff; border-color: rgba(10,124,255,0.12); }
      .card .title { font-weight: 600; color: #d7e8ff; }
      :root[data-theme="light"] .card .title { color: #0f1b36; }
      .card .desc { margin-top: 6px; color: #cfe0ff; font-size: 14px; line-height: 1.5; }
      :root[data-theme="light"] .card .desc { color: #30435f; }
      .kv { margin-top: 8px; font-size: 13px; color: var(--muted); display: flex; gap: 6px; align-items: baseline; }
      .kv b { color: #cfe0ff; font-weight: 600; }
      :root[data-theme="light"] .kv b { color: #0f1b36; }
      a.link { color: var(--brand-2); text-decoration: none; border-bottom: 1px dotted rgba(124,197,255,.5); }
      a.link:hover { color: white; border-bottom-color: white; }
      :root[data-theme="light"] a.link:hover { color: #0a7cff; border-bottom-color: #0a7cff; }

      .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.12), rgba(255,255,255,0.05)); background-size: 200% 100%; animation: shimmer 1.2s infinite; border-radius: 8px; }
      @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
      .skeleton-line { height: 12px; margin: 8px 0; }

      .theme-toggle { background: transparent; color: var(--text); border: 1px solid rgba(124,197,255,0.24); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
      :root[data-theme="light"] .theme-toggle { border-color: rgba(10,124,255,0.24); }
      .advice { background: var(--advice-bg); border: 1px solid var(--warn); border-radius: 12px; padding: 12px; margin: 12px 0; }
      .advice .desc { font-weight: 700; color: var(--advice-text); }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <header class="nav">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Recomendador Laboral EPN</h1>
            <div class="beta">Experiencia Personalizada</div>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="badge" id="career-badge">Listo</div>
          <button class="theme-toggle" id="theme-toggle" type="button" aria-label="Cambiar tema">Modo claro</button>
        </div>
      </header>

      <main class="layout">
        <section class="panel" aria-labelledby="form-title">
          <div class="head"><h2 id="form-title">Tu Perfil</h2></div>
          <div class="body">
            <form id="recom-form">
              <div style="margin-bottom:12px;">
                <label for="career">Carrera académica</label>
                <select id="career" name="career" required>
                  <option value="">Cargando...</option>
                </select>
              </div>
              <div style="margin-bottom:12px;">
                <label for="subjects">Asignaturas relevantes (opcional)</label>
                <input type="text" id="subjects" name="subjects" placeholder="Ej: Python, Machine Learning, Estadística" autocomplete="on">
              </div>
              <div>
                <label>Autoevaluación de habilidades blandas (1–5)</label>
                <div class="soft-grid" id="soft-skills"></div>
              </div>
              <div class="actions">
                <button class="btn" id="submit-btn" type="submit">Obtener recomendaciones</button>
              </div>
              <div class="actions">
                <button class="btn" id="reset-btn" type="button">Limpiar datos</button>
              </div>
              <div class="error" id="error" role="alert"></div>
            </form>
          </div>
        </section>

        <section class="panel" aria-labelledby="results-title">
          <div class="head"><h2 id="results-title">Resultados</h2></div>
          <div class="body">
            <div id="result"></div>
          </div>
        </section>
      </main>
    </div>

    <script>
      // Theme toggle with persistence
      function applyTheme(theme) {
        const t = theme === 'light' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', t);
        try { localStorage.setItem('theme', t); } catch {}
        const btn = document.getElementById('theme-toggle');
        if (btn) btn.textContent = t === 'dark' ? 'Modo claro' : 'Modo oscuro';
      }
      (function initTheme(){
        let saved = 'dark';
        try { saved = localStorage.getItem('theme') || 'dark'; } catch {}
        applyTheme(saved);
        const btn = document.getElementById('theme-toggle');
        if (btn) btn.addEventListener('click', () => {
          const current = document.documentElement.getAttribute('data-theme') || 'dark';
          applyTheme(current === 'dark' ? 'light' : 'dark');
        });
      })();

      const softSkillsLabels = [
        'Gestión',
        'Comunicación efectiva',
        'Liderazgo',
        'Trabajo en equipo',
        'Ética profesional',
        'Responsabilidad social',
        'Aprendizaje autónomo'
      ];

      const badge = document.getElementById('career-badge');

      // Render soft skills sliders
      const softSkillsDiv = document.getElementById('soft-skills');
      softSkillsLabels.forEach((label, i) => {
        const id = `soft-skill-${i}`;
        const wrapper = document.createElement('div');
        wrapper.className = 'soft-item';
        wrapper.innerHTML = `
          <div class="soft-row">
            <div class="soft-label">${label}</div>
            <div class="value" id="val-${i}">3</div>
          </div>
          <input type="range" min="1" max="5" value="3" step="1" class="slider" id="${id}" aria-label="${label}">
        `;
        softSkillsDiv.appendChild(wrapper);
      });
      // Update displayed values when sliders move
      softSkillsLabels.forEach((_, i) => {
        const input = document.getElementById(`soft-skill-${i}`);
        const out = document.getElementById(`val-${i}`);
        input.addEventListener('input', () => { out.textContent = input.value; });
      });

      // Populate careers
      fetch('http://localhost:5000/api/recommendations/careers')
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById('career');
          select.innerHTML = '<option value="">Selecciona una carrera</option>';
          if (data.success && data.data && data.data.careers) {
            data.data.careers.forEach(c => {
              const opt = document.createElement('option');
              opt.value = c; opt.textContent = c; select.appendChild(opt);
            });
            badge.textContent = `Conectando perfiles con oportunidades`;
          } else {
            select.innerHTML = '<option value="">No se pudieron cargar las carreras</option>';
            badge.textContent = 'Sin datos';
          }
        }).catch(() => { badge.textContent = 'Cargando…'; });

      function sanitizeAdvice(txt) {
        if (!txt) return '';
        let s = String(txt).replace(/\*\*[^*]+\*\*/g, '').trim();
        s = s.replace(/^(Oportunidades si mejoras tus habilidades blandas)\s*/i, '').trim();
        return s;
      }

      function card(rec, indexPrefix = '') {
        const explicacion = rec.explicacion_ai && rec.explicacion_ai.trim().length > 0 ? rec.explicacion_ai : 'Personalización AI no disponible para este resultado.';
        const angulo = rec.cosine_angle_deg ?? (rec.angulo_coseno ?? null);
        const similitud = rec.cosine_similarity ?? rec.similitud;
        const link = (rec.url || '').trim();
        const rank = rec.rank ?? indexPrefix;
        return `
          <div class="card">
            <div class="title">${rank}. ${rec.cargo}</div>
            <div class="desc">${explicacion}</div>
            ${link ? `<div class="kv"><b>Link:</b> <a class="link" href="${link}" target="_blank" rel="noopener noreferrer">Ver oferta</a></div>` : ''}
            <div class="kv"><b>Parámetros:</b> Ángulo coseno: ${angulo ? Number(angulo).toFixed(2) : 'N/A'}°, Similitud coseno: ${typeof similitud === 'number' ? Number(similitud).toFixed(4) : 'N/A'}</div>
          </div>
        `;
      }

      function skeletonCards(n=3) {
        let s = '';
        for (let i=0;i<n;i++) {
          s += `<div class="card"><div class="skeleton-line skeleton" style="width:40%"></div><div class="skeleton-line skeleton" style="width:95%"></div><div class="skeleton-line skeleton" style="width:88%"></div><div class="skeleton-line skeleton" style="width:30%"></div></div>`;
        }
        return s;
      }

      const resultEl = document.getElementById('result');
      function renderMain(carrera, recs) {
        let html = `<div class="result-section"><h3>Recomendaciones para ${carrera}</h3><div class="cards">`;
        recs.forEach(rec => { html += card(rec); });
        html += `</div></div>`;
        resultEl.innerHTML = html;
      }

      function renderAltLoading() {
        const alt = document.createElement('div');
        alt.id = 'alt-container';
        alt.className = 'result-section';
        alt.innerHTML = `<h3 style="margin-top:18px;">Oportunidades si mejoras tus habilidades blandas</h3><div class="cards">${skeletonCards(3)}</div>`;
        resultEl.appendChild(alt);
      }

      function renderAlt(consejo, recs) {
        const alt = document.getElementById('alt-container');
        let html = `<h3 style="margin-top:18px;">Oportunidades si mejoras tus habilidades blandas</h3>`;
        if (consejo) { html += `<div class="advice"><div class="desc">${consejo}</div></div>`; }
        html += `<div class="cards">`;
        recs.slice(0,5).forEach((rec, i) => { html += card(rec, String(i+1)); });
        html += `</div>`;
        alt.innerHTML = html;
      }

      document.getElementById('recom-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const err = document.getElementById('error');
        err.textContent = '';
        const btn = document.getElementById('submit-btn');
        btn.disabled = true; btn.textContent = 'Generando…';

        const career = document.getElementById('career').value;
        const subjects = document.getElementById('subjects').value;
        const softSkills = [];
        for (let i = 0; i < 7; i++) {
          const val = parseInt(document.getElementById('soft-skill-' + i).value, 10);
          if (isNaN(val) || val < 1 || val > 5) { err.textContent = 'Todas las habilidades blandas deben estar entre 1 y 5.'; btn.disabled = false; btn.textContent = 'Obtener recomendaciones'; return; }
          softSkills.push(val);
        }
        if (!career) { err.textContent = 'Selecciona una carrera.'; btn.disabled = false; btn.textContent = 'Obtener recomendaciones'; return; }

        const payload = { carrera: career, asignaturas: subjects, soft_skills: softSkills, include_alt: false };
        const altPayload = { carrera: career, asignaturas: subjects, soft_skills: softSkills, include_alt: true };

        try {
          const res = await fetch('http://localhost:5000/api/recommendations/predict', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!data.success) { err.textContent = data.message || 'Error en la recomendación.'; btn.disabled = false; btn.textContent = 'Obtener recomendaciones'; return; }
          const recs = data.data.recomendaciones;
          if (!recs || recs.length === 0) { resultEl.innerHTML = '<p>Sin recomendaciones.</p>'; btn.disabled = false; btn.textContent = 'Obtener recomendaciones'; return; }
          renderMain(data.data.carrera, recs);
          renderAltLoading();

          // Fetch alt async
          try {
            const resAlt = await fetch('http://localhost:5000/api/recommendations/predict', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(altPayload) });
            const dataAlt = await resAlt.json();
            if (dataAlt.success) {
              const consejo = sanitizeAdvice((dataAlt.data.mejora_soft_skills_mensaje || '').trim());
              const altRecs = dataAlt.data.recomendaciones_mejorando_soft_skills || [];
              renderAlt(consejo, altRecs);
            } else {
              renderAlt('No se pudieron generar alternativas.', []);
            }
          } catch (e2) {
            renderAlt('Error al cargar alternativas.', []);
          }
        } catch (e1) {
          err.textContent = 'No se pudo conectar con el backend.';
        } finally {
          btn.disabled = false; btn.textContent = 'Obtener recomendaciones';
        }
      });

      // Reset button logic: clears career, subjects, and resets soft skills to 3
      const resetBtn = document.getElementById('reset-btn');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          const careerSel = document.getElementById('career');
          const subjectsEl = document.getElementById('subjects');
          if (careerSel) careerSel.value = '';
          if (subjectsEl) subjectsEl.value = '';
          for (let i = 0; i < 7; i++) {
            const slider = document.getElementById('soft-skill-' + i);
            const valEl = document.getElementById('val-' + i);
            if (slider) slider.value = 3;
            if (valEl) valEl.textContent = '3';
          }
          // Clear results section as well
          const resultEl = document.getElementById('result');
          if (resultEl) resultEl.innerHTML = '';
          const err = document.getElementById('error');
          if (err) err.textContent = '';
        });
      }
    </script>
  </body>
  </html>
